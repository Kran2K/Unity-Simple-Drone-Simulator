# Unity Simple Drone Simulator

간단한 드론 비행 시뮬레이터 프로젝트입니다. Unity로 제작되었으며, 외부 제어를 위한 UDP 인터페이스를 중점적으로 다룹니다.

## 핵심 컨셉

이 시뮬레이터는 드론의 움직임을 시뮬레이션하고, 외부 클라이언트가 UDP 통신을 통해 드론의 상태를 제어하고 모니터링할 수 있도록 설계되었습니다.

핵심 로직은 `DroneManager.cs`에 구현되어 있으며, 외부 클라이언트는 정의된 JSON 프로토콜을 통해 드론과 상호작용합니다.

## 통신 프로토콜

통신은 **UDP**를 기반으로 하며, 데이터는 **JSON** 형식으로 직렬화됩니다.

-   **명령 수신 (Client -> Unity)**: Unity는 `50200` 포트에서 명령을 수신합니다.
-   **텔레메트리 송신 (Unity -> Client)**: Unity는 `<Client IP>:50100` 주소로 텔레메트리 데이터를 송신합니다.

### 텔레메트리 (Unity -> Client)

시뮬레이터는 드론의 상태 정보를 **20Hz** (`0.05초` 주기)로 클라이언트에 전송합니다.

-   **송신 주소**: `<Client IP>:50100`

**JSON 패킷 구조 (`DroneTelemetry`):**
```json
{
  "time": 120.5,
  "mode": "Position",
  "isArmed": true,
  "battery": 12.5,
  "dist_bottom": 4.95,
  "position": {"x": 0.0, "y": 5.0, "z": 0.0},
  "velocity": {"x": 0.0, "y": 0.0, "z": 0.0},
  "acceleration": {"x": 0.0, "y": 0.0, "z": 0.0},
  "attitude": {"x": 0.0, "y": 0.0, "z": 0.0},
  "angularVel": {"x": 0.0, "y": 0.0, "z": 0.0}
}
```

**필드 설명:**

| 필드           | 타입      | 설명                                                                                                                             |
| -------------- | --------- | -------------------------------------------------------------------------------------------------------------------------------- |
| `time`         | `double`  | 시뮬레이션 시작 후 경과 시간 (초).                                                                                             |
| `mode`         | `string`  | 현재 드론의 비행 모드. (`Disarmed`, `Position`, `Velocity`, `Takeoff`, `Land`)                                                   |
| `isArmed`      | `bool`    | 드론의 시동 상태. `true`이면 시동이 걸린 상태입니다.                                                                          |
| `battery`      | `float`   | 배터리 전압 (V).                                                                                                               |
| `dist_bottom`  | `float`   | 드론 하단의 센서로부터 지면까지의 수직 거리 (m). 감지 실패 시 `-1`.                                                            |
| `position`     | `Vector3` | **Home 기준** 로컬 좌표계 위치 (m). Home은 시뮬레이터 시작 시 드론의 위치입니다. (Unity 좌표계: Y-up)                        |
| `velocity`     | `Vector3` | **월드 좌표계** 기준 속도 (m/s).                                                                                                 |
| `acceleration` | `Vector3` | **월드 좌표계** 기준 가속도 (m/s²).                                                                                              |
| `attitude`     | `Vector3` | 드론의 자세. `x`: **Roll**, `y`: **Pitch**, `z`: **Yaw**. 단위는 도(degree)이며, Roll/Pitch는 `-180 ~ 180` 범위입니다. |
| `angularVel`   | `Vector3` | **월드 좌표계** 기준 각속도 (deg/s). 현재 Yaw 각속도만 지원됩니다 (`y` 필드).                                                    |

---
### 명령 (Client -> Unity)

클라이언트는 제어 명령을 JSON 형식으로 Unity에 전송하여 드론의 모드를 변경하거나 움직임을 제어합니다.

-   **수신 포트**: `50200`

**JSON 패킷 구조 (`DroneCommand`):**
```json
{
  "type": "CMD",
  "mode": "POS",
  "x": 0.0,
  "y": 5.0,
  "z": 10.0,
  "yaw": 90.0
}
```

**필드 설명:**

| 필드   | 타입     | 설명                                                                                                                                              |
| ------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| `type` | `string` | 명령의 종류. `MODE` (모드 변경) 또는 `CMD` (이동/제어) 중 하나입니다.                                                                              |
| `mode` | `string` | `type`이 `MODE`일 때 사용됩니다. 변경할 목표 모드를 지정합니다. (`TAKEOFF`, `LAND`, `POS`, `VEL`)                                                    |
| `x`    | `float`  | `type`이 `CMD`일 때 사용되며, 현재 비행 모드에 따라 위치 또는 속도 목표치를 나타냅니다. (아래 비행 모드 섹션 참고)                                 |
| `y`    | `float`  | `type`이 `CMD`일 때 사용되며, 현재 비행 모드에 따라 위치 또는 속도 목표치를 나타냅니다.                                                              |
| `z`    | `float`  | `type`이 `CMD`일 때 사용되며, 현재 비행 모드에 따라 위치 또는 속도 목표치를 나타냅니다.                                                              |
| `yaw`  | `float`  | `type`이 `CMD`일 때 사용되며, 목표 Yaw 각도(heading)를 도(degree) 단위로 나타냅니다. `NaN`일 경우 `yaw_rate`만 사용하여 제어합니다.                      |
| `yaw_rate`| `float` | `type`이 `CMD`일 때 사용되며, Yaw 회전 속도(deg/s)를 제한하거나 제어합니다. (기본값: `0`) <br> - `yaw`와 함께 사용 시: 해당 속도로 목표 각도까지 이동. <br> - `yaw`가 `NaN`일 시: 해당 속도로 계속 회전. |

---
## 좌표계 가이드 (NED vs. Unity)

드론 제어에서는 주로 **NED (North-East-Down)** 좌표계를 사용하지만, Unity는 다른 좌표계를 사용하므로 데이터 해석에 주의가 필요합니다. 이 시뮬레이터는 **Unity의 좌표계**를 기준으로 모든 입출력을 처리합니다.

#### **Unity 좌표계 (Left-Handed, Y-Up)**
-   **X+**: 앞쪽 (Forward)
-   **Y+**: 상승 (Up)
-   **Z+**: 왼쪽 (Left)

#### **NED 좌표계 (Right-Handed, Z-Down)**
-   **X+**: 북쪽 (North)
-   **Y+**: 동쪽 (East)
-   **Z+**: 아래쪽 (Down)

#### **시뮬레이터 입출력 매핑**

**이 시뮬레이터와 통신하는 모든 클라이언트는 Unity 좌표계를 기준으로 데이터를 보내고 받아야 합니다.** `DroneCommand`의 `x, y, z` 값과 `DroneTelemetry`의 `position, velocity` 등 모든 벡터 데이터는 Unity 월드 좌표계를 따릅니다.

만약 클라이언트가 NED 좌표계를 사용한다면, 시뮬레이터로 명령을 보내기 전에 다음과 같이 변환해야 합니다.

**NED -> Unity 변환 규칙:**
-   Unity `x` (앞쪽) = NED `x` (북쪽)
-   Unity `y` (상승) = -NED `z` (아래쪽)
-   Unity `z` (왼쪽) = -NED `y` (동쪽)

**예시 (NED 위치 `[10, 2, -5]`를 Unity로 변환):**
-   NED `(N:10, E:2, D:-5)` 는 "북쪽으로 10m, 동쪽으로 2m, 위로 5m"를 의미합니다.
-   Unity 좌표 `(x, y, z)` 로는 `(10, 5, -2)` 가 됩니다. 이 값을 `DroneCommand`에 넣어 전송해야 합니다.

---
## 비행 모드

드론은 여러 비행 모드를 가지며, 각 모드에서 `CMD` 타입 명령을 다르게 해석합니다.

### `Disarmed` (시동 꺼짐)
-   시동이 꺼져있는 기본 상태이며, `isArmed`는 `false`입니다.
-   `CMD` 타입의 이동/회전 명령을 무시합니다.

### `Takeoff` (이륙)
-   `MODE: "TAKEOFF"` 명령으로 진입합니다.
-   시동이 꺼져있었다면 시동을 겁니다 (`isArmed = true`).
-   목표 고도에 도달하면 자동으로 **`Position` 모드로 전환**됩니다.

### `Position` (위치 제어)
-   `MODE: "POS"` 명령으로 진입하거나, 이륙 완료 후 자동으로 전환됩니다.
-   `CMD` 명령을 **목표 위치**로 해석합니다.
    -   `x`, `y`, `z`: **Home 기준** 목표 절대 위치 (m). 
    -   `yaw`: 목표 Yaw 각도 (degree).

### `Velocity` (속도 제어)
-   `MODE: "VEL"` 명령으로 진입합니다.
-   `CMD` 명령을 **목표 속도**로 해석합니다.
    -   `x`, `y`, `z`: **World 좌표계** 기준 목표 속도 (m/s).
    -   `yaw`: 목표 Yaw 각도 (degree). (Yaw는 속도가 아닌 각도 제어입니다.)

### `Land` (착륙)
-   `MODE: "LAND"` 명령으로 진입합니다.
-   수평 이동을 멈추고 현재 위치에서 수직으로 착륙을 시작합니다.
-   고도에 따라 착륙 속도를 조절하며 안전하게 하강합니다.
-   지면에 완전히 착륙하면 **자동으로 시동을 끄고 `Disarmed` 모드로 전환**됩니다.

## 시작하기

### 요구 사양

-   **Unity**: `2022.3.x` 또는 그 이상 (LTS 버전 권장)
-   **Python**: `3.x` (예제 클라이언트 실행용)


## 예제 클라이언트 (`drone_tester.py`)

프로젝트 `Examples` 폴더에 Python으로 작성된 간단한 GUI 클라이언트가 포함되어 있어, 별도의 개발 없이 시뮬레이터를 테스트해볼 수 있습니다. 이 코드는 프로토콜을 구현하는 데 좋은 참고 자료가 될 수 있습니다.

## 라이선스

이 프로젝트는 [MIT License](LICENSE)를 따릅니다.